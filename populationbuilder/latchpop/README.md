# Building the LATCH ABM Population 

This project builds the LATCH ABM population, using input ABS census data.

## Build Instructions

### Prerequisits
* JAVA 8 (https://java.com/en/download/)
* Maven (https://maven.apache.org/download.cgi)
* ABS TableBuilder Pro access to download data

There are 4 maven projects that needs to be built. They are all subprojects of `populationbuilder` project. To build all the 4 projects at once change directory to `buildpopulation/populationbuilder` and execute below command.

        > mvn clean install

## Run Instructions

To run the code and generate the latch population, change directory to `buildpopulation/populationbuilder/latchpop/` and execute:

        > java -jar target/latchpop.jar population.properties

## Importing the project into Eclipse

This project is nested under `populationbuilder` parent project. We have to import this project as a child project of `populationbuilder` parent project. Follow below instructions to import all the required projects into Eclipse.

   1. File > Import...
   2. In Import console, select Maven > Existing Maven Projects > Next
   3. In Import Maven Project console, set `populationbuilder` as the Root Directory. This will show available projects
   4. Select `populationbuilder` and its child projects
   5. Click Finish
  
This will automatically create the required Eclipse configuration files (.project, .classpath, .settings) and import all the projects under `populationbuilder`.

When checking in any changes to the repository do not push .project, .classpath and .settings. Otherwise there will be conflicts when using with different Eclipse versions.

## Output file

The program produces 3 files contaning all househods, all families and all persons. Files are saved to `buildpopulation/data/latch/locationaldata/`. Files can be viewed plain text viewers or spread sheet processors.

  * `AllAgents.csv` -  Each record represents a person in the population. "AgentId" is a unique key. Family members are given in (MotherId, FatherId, ChildrenIds, RelativeIds) fields and each Id points to a record in the file.
  * `AllHouseholds.csv` - Each record represents a household. "GroupId" uniquely identifies a household. A household can be made of several families. "FamilyIds" are foreign keys to records in "AllFamilies.csv"
  * `AllFamilies.csv` - Each record represents a family. "FamilyId" is the primary key. "HouseholdId" is a foreign key representing a record in "AllHouseholds.csv". "Members" field gives IDs of persons in a family, which are foreign keys pointing to "AllAgents.csv".

## population.properties file instructions

This file contains all the properties for constructing the popoulation

* `SA2InputDataDirectory` -  Location of processed household and individual input data files by SA2. Each directory represents an SA2. There must be 3 files named Hh.csv, Indiv.csv and SA1Hhs.csv. These files are generated by the preprocessing program.
* `SA1HhDistFileProperties` - Properties of file describing distribution of different family households types in SA1s within an SA1.
* `RandomSeed` - Seed for random number generator
* `SA2List` - Comma seperated list of SA2 names. There must be a directory for each SA2 name in `SA2InputDataDirectory`
* `AgeDistributionFile` - File containing overall age distribution of the population and file properties used for reading into program. `AgeColumn` -  colum with age titles; `PercentageColumn` - data column to read to get age distribution (This needs to be Total column); `DataStartRow` - Row that starts values (after column titles).
* `SA2OutputLocation` - Output location of the constructed population by SA2
* `SA1OutputLocation` - Output location of the constructed population by SA1
* `AllHouseholdsCsv` - Output file containing all the households in whole population
* `AllFamiliesCsv` - Output file containing all the families in whole population
* `AllAgentsCsv` - Output file containing all the agens in whole population
* `SACodesZip` - The zip file downloaded from ABS containing all the Statistical Area codes. This is used to convert from one code to another. (Download 'Statistical Area Level 1 (SA1) ASGS Edition 2011 in .csv Format' zip file from this [link](http://www.abs.gov.au/AUSSTATS/abs@.nsf/DetailsPage/1270.0.55.001July%202011))
* `SACodesCsvInSACodesZip` - Name of the relavent csv file in above zip
* `ReferenceColumnHeader` - The column name (code identifier) of the code we want to convert from
* `TargetColumnHeader` - The column name (code identifier) of the code we want to convert to
* `EnableSummaryReports` - generate summary of household and person distribution for each SA2 if value is set to 'true'
* `SexRatio` -  Ratio of male and females (usually 0.5)
* `RelativesProbability` - Probabiliy of selecting a relative as a member for households not compulsory to have relatives - set to 0.6 (e.g. Married couple with children)
* `FemaleLoneParentProbability` - Probability of selecting a female as a lone parent when lone parent's sex is not given

## Known Exceptions

```
#!Java
WARNING | Multi-family househods: Children: 0 Relatives: 1 Extras: 0
Exception in thread "main" java.lang.Error: Multi-family househods: Cannot form more households. All extra persons consumed
	at bnw.abm.intg.populationbuilder.latchpop.GroupMaker.fillChildrenAndRelativesUsingExtras(GroupMaker.java:717)
	at bnw.abm.intg.populationbuilder.latchpop.GroupMaker.addNonPrimaryFamiliesToMultiFamilyHousehold(GroupMaker.java:575)
	at bnw.abm.intg.populationbuilder.latchpop.GroupMaker.makePopulation(GroupMaker.java:92)
	at bnw.abm.intg.populationbuilder.latchpop.App.main(App.java:74)
```
This exception occurs because all extra persons were exausted but still family could not be completed. If the number of remaining relatives according warning message is not zero (in this case we have 1 unused relative), that means grouping process had decided to create extra children where relatives should have been used. The exception can be avoided by changing the `RelativesProbabiliy`. The program uses same instance of java.util.Random throughout. So, when `RelativesProbability` is changed, it is normal to see changes in other aspects where the random number sequence is used.

Relatives are temporarily removed from the population until other dependencies are able to required demographic changes. Apply `buildpopulation/populationbuilder/latchpop/UnhideRelatives.patch/` to stop removing relatives from population. IMPORTANT: no exceptions or warnings given at the moment.